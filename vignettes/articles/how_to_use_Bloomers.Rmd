---
title: "Bloomers work flow example"
author: "Ona Deulofeu Capo"
date: "2023-05-11"
output: github_document

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Import functions and upload libraries
```{r}
library(devtools)
#install_github(repo = "EcologyR/Bloomers")
library(tidyverse)
library(vegan)
library(Bloomers)

source('../../R/community_evenness.R')
```

# Get example data
```{r}
setwd('../../')
data <- prepare_example_data()
head(data)
```

# Preprocessing data 
## Calculate relative abundances
```{r}
asv_tab_l_rel_abund <- data$asv_tab_l %>%
  calculate_rel_abund(group_cols = sample_id)
head(asv_tab_l_rel_abund)
```
## Calculate pseudoabundandances
Pseudoabundances are relative abundances multiplied by total abundance data for each sample.
```{r}
asv_tab_pseudoabund <- asv_tab_l_rel_abund %>%
  calculate_pseudoabund(abund_data = data$abund_data,  by_ =  c('sample_id', 'sampling_site'),
                        rel_abund = as.numeric(relative_abundance),
                        total_abund = as.numeric(mean_total_bac))
head(asv_tab_pseudoabund)
```
# Calculate diversity parammeters
We calculate different diversity parameters to check if the blooming events detected have an effect on the community structure
## Community eveness
```{r}
community_eveness <- asv_tab_pseudoabund %>%
  select(sample_id, reads, asv_num) %>%
  as_tibble() %>%
  group_by(sample_id) %>%
  dplyr::summarize(community_eveness_result = community_evenness(abundances = reads, index = "Eveness"))
head(community_eveness)
```
## Community Bray-Curtis dissimilarity
```{r}
bray_curtis_results <- dissimilarity_matrix(data = asv_tab_l_rel_abund, sample_id_col = sample_id)
head(bray_curtis_results)
```
# Discover anomalies
## For relative abundances and pseudoabundances
```{r}
z <- asv_tab_pseudoabund %>%
  as_tibble() %>%
  group_by(asv_num) %>%
  dplyr::summarize(anomalies_ab = get_anomalies(values = pseudoabundance, plotting = TRUE)[[1]],
                   anomalies_ra = get_anomalies(values = relative_abundance, plotting = TRUE)[[1]])
z
```
## For community eveness and bray curtis dissimilarity
```{r}
z_diversity <- bray_curtis_results %>%
  cbind(community_eveness) %>%
  #ungroup() %>%
  #group_by(sample_id) %>%
  dplyr::summarize(anomalies_bray = get_anomalies(values = bray_curtis_result, plotting = FALSE)[c(1,2)],
                   anomalies_eveness = get_anomalies(values = community_eveness_result, plotting = FALSE)[[1]])

z_diversity %>%
  str()
```
# Summarize blooming events

```{r}
blooming_summary(asv_tab_pseudoabund, z_vector = )
```


